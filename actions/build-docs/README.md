# Build Documentation Action

This action builds documentation using MkDocs and deploys it to a target branch. It's designed to work with the CMIP-LD copier template system and triggers when there are updates to the production branch or via manual dispatch.

## Features

- üèóÔ∏è **Smart Building**: Uses MkDocs to build documentation from configured sources
- üîç **Change Detection**: Only deploys if changes are detected (unless forced)
- üåø **Git Worktree**: Uses git worktree for efficient branch management
- ü™ù **Hooks Support**: Runs pre-build hooks if available
- üìä **Detailed Logging**: Comprehensive logging and step summaries
- üéØ **Flexible Triggers**: Supports push and workflow dispatch events

## Usage

### Basic Usage

```yaml
- name: Build and Deploy Documentation
  uses: WCRP-CMIP/CMIP-LD/actions/build-docs@main
```

### With Custom Configuration

```yaml
- name: Build and Deploy Documentation
  uses: WCRP-CMIP/CMIP-LD/actions/build-docs@main
  with:
    source_branch: 'production'
    target_branch: 'gh-pages'
    config_file: '.src/mkdocs/mkdocs.yml'
    docs_dir: 'docs'
    force_deploy: false
```

## Inputs

| Input | Description | Required | Default |
|-------|-------------|----------|---------|
| `source_branch` | Source branch to build from | No | `production` |
| `target_branch` | Target branch to deploy to | No | `gh-pages` |
| `config_file` | Path to mkdocs.yml config file | No | `.src/mkdocs/mkdocs.yml` |
| `python_version` | Python version to use | No | `3.11` |
| `docs_dir` | Directory name in target branch | No | `docs` |
| `force_deploy` | Force deployment even if no changes | No | `false` |

## Outputs

| Output | Description |
|--------|-------------|
| `deployed_branch` | Branch where docs were deployed |
| `deployed_path` | Path where docs were deployed |
| `deployment_status` | Status: `success`, `no_changes`, or `failed` |

## Workflow Integration

This action is typically used in a workflow that triggers on:
- Push to `production` branch
- Manual workflow dispatch

### Example Workflow

```yaml
name: Build Documentation

on:
  push:
    branches: [ production ]
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch to build from'
        required: false
        default: 'production'
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: false
        type: boolean

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build and Deploy Documentation
        uses: WCRP-CMIP/CMIP-LD/actions/build-docs@main
        with:
          source_branch: ${{ github.event.inputs.source_branch || 'production' }}
          force_deploy: ${{ github.event.inputs.force_deploy || 'false' }}
```

## How It Works

1. **Setup**: Configures Git and Python environment
2. **Dependencies**: Installs MkDocs and required packages
3. **Verification**: Checks for configuration files and source content
4. **Hooks**: Runs any pre-build Python hooks
5. **Build**: Builds documentation using MkDocs
6. **Worktree**: Sets up target branch using git worktree
7. **Change Detection**: Compares new build with existing docs
8. **Deploy**: Copies built site to target branch (if changes detected)
9. **Commit**: Commits and pushes changes to target branch
10. **Cleanup**: Removes worktree and provides summary

## Dependencies

The action will install dependencies in this order:
1. From `.src/mkdocs/requirements.txt` (if it exists)
2. Default packages: `mkdocs mkdocs-material mkdocs-plotly-plugin mkdocs-gen-files mkdocs-literate-nav pymdown-extensions`

## Project Structure

This action expects your project to follow the CMIP-LD structure:

```
project/
‚îú‚îÄ‚îÄ .src/
‚îÇ   ‚îî‚îÄ‚îÄ mkdocs/
‚îÇ       ‚îú‚îÄ‚îÄ mkdocs.yml          # MkDocs configuration
‚îÇ       ‚îî‚îÄ‚îÄ requirements.txt     # Python dependencies (optional)
‚îú‚îÄ‚îÄ docs/                       # Source documentation (optional)
‚îú‚îÄ‚îÄ hooks/                      # Pre-build Python hooks (optional)
‚îî‚îÄ‚îÄ .github/
    ‚îî‚îÄ‚îÄ workflows/
        ‚îî‚îÄ‚îÄ build-docs.yml      # This workflow
```

## GitHub Pages Integration

The action automatically:
- Adds `.nojekyll` file for GitHub Pages compatibility
- Copies `404.html` if generated by MkDocs
- Preserves other files in the target branch

Configure GitHub Pages to deploy from the target branch and docs directory.

## Change Detection

The action compares the newly built documentation with the existing docs in the target branch. If no changes are detected, deployment is skipped unless `force_deploy` is set to `true`.

## Error Handling

The action includes comprehensive error handling:
- Validates configuration files exist
- Verifies successful builds
- Provides detailed error messages
- Cleans up resources even on failure

## Troubleshooting

### Common Issues

1. **Config file not found**: Ensure `.src/mkdocs/mkdocs.yml` exists
2. **Build fails**: Check MkDocs configuration and source files
3. **Permission errors**: Ensure the GitHub token has write access to the target branch
4. **No changes deployed**: This is normal behavior unless `force_deploy` is true

### Debug Mode

For verbose output, the action uses `mkdocs build --verbose` and provides detailed logging throughout the process.

## Integration with Copier Template

This action is designed to work with the CMIP-LD copier template system. The workflow template is automatically generated when using the mkdocs copier template with the appropriate configuration.
