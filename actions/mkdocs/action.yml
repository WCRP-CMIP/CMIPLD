name: 'Build and Deploy MkDocs to Production Branch'
description: 'Build MkDocs on main branch, deploy to production branch using git worktree'
author: 'CMIP-IPO'

inputs:
  source_branch:
    description: 'Source branch to build from'
    required: false
    default: 'main'
  target_branch:
    description: 'Target branch to deploy to'
    required: false
    default: 'production'
  config_file:
    description: 'Path to mkdocs.yml config file'
    required: false
    default: '.src/mkdocs/mkdocs.yml'
  python_version:
    description: 'Python version to use'
    required: false
    default: '3.11'
  docs_dir:
    description: 'Directory name in target branch'
    required: false
    default: 'docs'
<<<<<<< HEAD
  site_dir:
    description: 'Directory where MkDocs builds the site (temporary build directory)'
    required: false
    default: '.src/mkdocs/site'
=======
>>>>>>> 8e88d9a (actions and docs)

outputs:
  deployed_branch:
    description: 'Branch where docs were deployed'
    value: ${{ inputs.target_branch }}
  deployed_path:
    description: 'Path where docs were deployed'
    value: ${{ inputs.docs_dir }}

runs:
  using: 'composite'
  steps:
<<<<<<< HEAD

    - name: Fetch all branches
      shell: bash
      run: git fetch --all

    - name: Set up environment variables
      shell: bash
      run: |
        echo "REPO_ROOT=$(pwd)" >> $GITHUB_ENV
        echo "SITE_DIR_PATH=$(pwd)/${{ inputs.site_dir }}" >> $GITHUB_ENV
        echo "WORKTREE_PATH=$(pwd)/production-deploy" >> $GITHUB_ENV
        echo "üìÅ Repository root: $(pwd)"
        echo "üìÅ Site directory will be: $(pwd)/${{ inputs.site_dir }}"
        echo "üìÅ Worktree will be: $(pwd)/production-deploy"

=======
>>>>>>> 8e88d9a (actions and docs)
    - name: Set up Git configuration
      shell: bash
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git config --global init.defaultBranch main

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version }}

    - name: Install MkDocs dependencies
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
=======
>>>>>>> 8e88d9a (actions and docs)
        python -m pip install --upgrade pip
        
        # Install from requirements file if it exists
        if [ -f ".src/mkdocs/requirements.txt" ]; then
          echo "üì¶ Installing from .src/mkdocs/requirements.txt"
          pip install -r .src/mkdocs/requirements.txt
        else
          echo "üì¶ Installing default MkDocs packages"
          pip install mkdocs mkdocs-material mkdocs-plotly-plugin mkdocs-gen-files mkdocs-literate-nav pymdown-extensions
        fi

    - name: Verify MkDocs config
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
=======
>>>>>>> 8e88d9a (actions and docs)
        if [ ! -f "${{ inputs.config_file }}" ]; then
          echo "‚ùå MkDocs config file not found: ${{ inputs.config_file }}"
          exit 1
        fi
        echo "‚úÖ Found MkDocs config: ${{ inputs.config_file }}"

    - name: Build MkDocs
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
        echo "üèóÔ∏è Building MkDocs documentation..."
        echo "üìÅ Repository root: ${REPO_ROOT}"
        echo "üìÅ Building to directory: ${SITE_DIR_PATH}"
        
        # Clean any existing site directory
        if [ -d "${SITE_DIR_PATH}" ]; then
          echo "üßπ Cleaning existing site directory..."
          rm -rf "${SITE_DIR_PATH}"
        fi
        
        mkdocs build -f "${{ inputs.config_file }}" -d "${SITE_DIR_PATH}"
        
        # Verify build was successful
        if [ ! -d "${SITE_DIR_PATH}" ]; then
          echo "‚ùå Build failed - no site directory created at: ${SITE_DIR_PATH}"
          exit 1
        fi
        
        if [ ! -f "${SITE_DIR_PATH}/index.html" ]; then
          echo "‚ùå Build failed - no index.html in output directory: ${SITE_DIR_PATH}"
          exit 1
        fi
        
        echo "‚úÖ MkDocs build completed successfully"
        echo "üìä Build summary:"
        echo "   - Output directory: ${SITE_DIR_PATH}"
        echo "   - Files generated: $(find "${SITE_DIR_PATH}" -type f | wc -l)"
        echo "   - Total size: $(du -sh "${SITE_DIR_PATH}" | cut -f1)"
=======
        echo "üèóÔ∏è Building MkDocs documentation..."
        mkdocs build -f "${{ inputs.config_file }}" -d "site"
        
        # Verify build was successful
        if [ ! -d "site" ]; then
          echo "‚ùå Build failed - no site directory created"
          exit 1
        fi
        
        if [ ! -f "site/index.html" ]; then
          echo "‚ùå Build failed - no index.html in output"
          exit 1
        fi
        
        echo "‚úÖ MkDocs build completed"
>>>>>>> 8e88d9a (actions and docs)

    - name: Setup production branch with git worktree
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
        echo "üåø Setting up production branch with git worktree..."
        echo "üìÅ Repository root: ${REPO_ROOT}"
        echo "üìÅ Worktree path: ${WORKTREE_PATH}"
        
        # Clean up any existing worktree first
        if [ -d "${WORKTREE_PATH}" ]; then
          echo "üßπ Cleaning up existing worktree..."
          git worktree remove "${WORKTREE_PATH}" --force 2>/dev/null || true
        fi
        
        # Check if production branch exists remotely
        if git ls-remote --heads origin ${{ inputs.target_branch }} | grep -q ${{ inputs.target_branch }}; then
          echo "üì• Production branch exists remotely, fetching..."
          git fetch origin ${{ inputs.target_branch }}
          
          # Check if local branch exists
          if git show-ref --verify --quiet refs/heads/${{ inputs.target_branch }}; then
            echo "üìã Local branch exists, updating..."
            git checkout ${{ inputs.target_branch }}
            git pull origin ${{ inputs.target_branch }}
            git worktree add "${WORKTREE_PATH}" ${{ inputs.target_branch }}
          else
            echo "üìã Creating local branch from remote..."
            git worktree add "${WORKTREE_PATH}" origin/${{ inputs.target_branch }} -b ${{ inputs.target_branch }}
          fi
          echo "BRANCH_EXISTS=true" >> $GITHUB_ENV
        else
          echo "üÜï Creating new production branch..."
          git worktree add --orphan "${WORKTREE_PATH}" ${{ inputs.target_branch }}
          cd "${WORKTREE_PATH}"
          git rm -rf . 2>/dev/null || true
          cd "${REPO_ROOT}"
          echo "BRANCH_EXISTS=false" >> $GITHUB_ENV
=======
        echo "üåø Setting up production branch with git worktree..."
        
        # Check if production branch exists remotely
        if git ls-remote --heads origin ${{ inputs.target_branch }} | grep -q ${{ inputs.target_branch }}; then
          echo "üì• Production branch exists, fetching..."
          git fetch origin ${{ inputs.target_branch }}
          git worktree add production-deploy origin/${{ inputs.target_branch }}
        else
          echo "üÜï Creating new production branch..."
          git worktree add --orphan production-deploy ${{ inputs.target_branch }}
          cd production-deploy
          git rm -rf . 2>/dev/null || true
          cd ..
>>>>>>> 8e88d9a (actions and docs)
        fi
        
        echo "‚úÖ Production branch worktree ready"

    - name: Deploy to production branch
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
        echo "üìÅ Deploying to production branch..."
        echo "üìÅ Source: ${SITE_DIR_PATH}"
        echo "üìÅ Target: ${WORKTREE_PATH}/src-data/${{ inputs.docs_dir }}"
        
        # Only clear the docs directory, keep everything else
        cd "${WORKTREE_PATH}"
        
        # Remove only the docs directory if it exists
        if [ -d "src-data/${{ inputs.docs_dir }}" ]; then
          echo "üóëÔ∏è Clearing existing src-data/${{ inputs.docs_dir }}/ directory..."
          rm -rf "src-data/${{ inputs.docs_dir }}"
        fi
        
        cd "${REPO_ROOT}"
        
        # Create fresh docs directory and copy built site
        mkdir -p "${WORKTREE_PATH}/src-data/${{ inputs.docs_dir }}"
        cp -r "${SITE_DIR_PATH}"/* "${WORKTREE_PATH}/src-data/${{ inputs.docs_dir }}/"
        
        # Add .nojekyll file for GitHub Pages (only if it doesn't exist)
        if [ ! -f "${WORKTREE_PATH}/.nojekyll" ]; then
          touch "${WORKTREE_PATH}/.nojekyll"
        fi
        
        # Add 404.html if it exists in build (only if it doesn't exist)
        if [ -f "${SITE_DIR_PATH}/404.html" ] && [ ! -f "${WORKTREE_PATH}/404.html" ]; then
          cp "${SITE_DIR_PATH}/404.html" "${WORKTREE_PATH}/404.html"
        fi
        
        echo "‚úÖ Files transferred to production branch src-data/${{ inputs.docs_dir }}/ folder"
=======
        echo "üìÅ Deploying to production branch..."
        
        # Only clear the docs directory, keep everything else
        cd production-deploy
        
        # Remove only the docs directory if it exists
        if [ -d "${{ inputs.docs_dir }}" ]; then
          echo "üóëÔ∏è Clearing existing ${{ inputs.docs_dir }}/ directory..."
          rm -rf "${{ inputs.docs_dir }}"
        fi
        
        cd ..
        
        # Create fresh docs directory and copy built site
        mkdir -p production-deploy/${{ inputs.docs_dir }}
        cp -r site/* production-deploy/${{ inputs.docs_dir }}/
        
        # Add .nojekyll file for GitHub Pages (only if it doesn't exist)
        if [ ! -f "production-deploy/.nojekyll" ]; then
          touch production-deploy/.nojekyll
        fi
        
        # Add 404.html if it exists in build (only if it doesn't exist)
        if [ -f "site/404.html" ] && [ ! -f "production-deploy/404.html" ]; then
          cp site/404.html production-deploy/404.html
        fi
        
        echo "‚úÖ Files transferred to production branch docs/ folder"
>>>>>>> 8e88d9a (actions and docs)

    - name: Commit and push to production
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${WORKTREE_PATH}"
        echo "üì§ Committing and pushing to production..."
        echo "üìÅ Working in: $(pwd)"
        echo "üìã Branch exists: ${BRANCH_EXISTS}"
        
        # Debug git status
        echo "üîç Git status:"
        git status --porcelain
        echo "üîç Current branch:"
        git branch --show-current
        echo "üîç Remote tracking:"
        git branch -vv
=======
        echo "üì§ Committing and pushing to production..."
        
        cd production-deploy
>>>>>>> 8e88d9a (actions and docs)
        
        # Add all files
        git add .
        
<<<<<<< HEAD
        # Check if there are changes to commit or if this is a new branch
        if [ -n "$(git status --porcelain)" ] || [ "${BRANCH_EXISTS}" = "false" ]; then
          if [ "${BRANCH_EXISTS}" = "false" ]; then
            echo "üÜï Making initial commit for new branch"
            git commit -m "üìö Initial documentation deployment from ${{ inputs.source_branch }} - $(date +'%Y-%m-%d %H:%M:%S')"
          else
            echo "üìù Updating existing branch"
            git commit -m "üìö Deploy documentation from ${{ inputs.source_branch }} - $(date +'%Y-%m-%d %H:%M:%S')"
          fi
          
          # Ensure we're tracking the remote branch properly
          CURRENT_BRANCH=$(git branch --show-current)
          echo "üîó Setting up remote tracking for branch: ${CURRENT_BRANCH}"
          git branch --set-upstream-to=origin/${{ inputs.target_branch }} "${CURRENT_BRANCH}" || true
          
          # Push to origin
          echo "üöÄ Pushing to origin/${{ inputs.target_branch }}..."
          git push origin "${CURRENT_BRANCH}":${{ inputs.target_branch }}
=======
        # Check if there are changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "üìö Deploy documentation from ${{ inputs.source_branch }} - $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin ${{ inputs.target_branch }}
>>>>>>> 8e88d9a (actions and docs)
          echo "‚úÖ Documentation deployed to ${{ inputs.target_branch }} branch"
        else
          echo "‚ÑπÔ∏è No changes to deploy"
        fi
<<<<<<< HEAD
=======
        
        cd ..
>>>>>>> 8e88d9a (actions and docs)

    - name: Cleanup worktree
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
        echo "üßπ Cleaning up worktree..."
        git worktree remove "${WORKTREE_PATH}" --force || true
=======
        echo "üßπ Cleaning up worktree..."
        git worktree remove production-deploy --force || true
>>>>>>> 8e88d9a (actions and docs)
        echo "‚úÖ Worktree cleaned up"

    - name: Deployment summary
      shell: bash
      run: |
<<<<<<< HEAD
        cd "${REPO_ROOT}"
=======
>>>>>>> 8e88d9a (actions and docs)
        echo "## üéâ MkDocs Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Source branch**: \`${{ inputs.source_branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Target branch**: \`${{ inputs.target_branch }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Config file**: \`${{ inputs.config_file }}\`" >> $GITHUB_STEP_SUMMARY
<<<<<<< HEAD
        echo "- **Site directory**: \`${{ inputs.site_dir }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Docs directory**: \`src-data/${{ inputs.docs_dir }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ‚úÖ Deployment completed" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "${SITE_DIR_PATH}" ]; then
          file_count=$(find "${SITE_DIR_PATH}" -type f | wc -l)
          size=$(du -sh "${SITE_DIR_PATH}" | cut -f1)
=======
        echo "- **Docs directory**: \`${{ inputs.docs_dir }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ‚úÖ Deployment completed" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "site" ]; then
          file_count=$(find "site" -type f | wc -l)
          size=$(du -sh "site" | cut -f1)
>>>>>>> 8e88d9a (actions and docs)
          echo "- **Files deployed**: \`$file_count\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Total size**: \`$size\`" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üåê Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation is now available on the \`${{ inputs.target_branch }}\` branch" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Pages will automatically deploy from \`${{ inputs.target_branch }}/${{ inputs.docs_dir }}\`" >> $GITHUB_STEP_SUMMARY
