name: 'Check Context URLs'
description: 'Validate that all @context URLs in _context files are accessible'
inputs:
  create-issue:
    description: 'Create an issue if context URLs fail (default: false)'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for creating issues (required if create-issue is true)'
    required: false

outputs:
  status:
    description: 'Overall status (success/failure)'
    value: ${{ steps.check.outputs.status }}
  failed-count:
    description: 'Number of failed context URLs'
    value: ${{ steps.check.outputs.failed_count }}

runs:
  using: 'composite'
  steps:
    - name: Check context URLs
      id: check
      shell: bash
      run: |
        set +e
        
        echo "## Context URL Validation" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Extract unique URLs using Python (handles nested directories and nested @context)
        UNIQUE_URLS=$(python3 << 'PYEOF'
        import json
        import os
        
        def extract_urls(obj, urls):
            """Recursively extract all HTTP URLs from @context fields."""
            if isinstance(obj, str):
                if obj.startswith('http'):
                    urls.add(obj)
            elif isinstance(obj, list):
                for item in obj:
                    extract_urls(item, urls)
            elif isinstance(obj, dict):
                for key, value in obj.items():
                    if key == '@context':
                        extract_urls(value, urls)
                    elif isinstance(value, (dict, list)):
                        extract_urls(value, urls)
        
        urls = set()
        
        for root, dirs, files in os.walk('.'):
            dirs[:] = [d for d in dirs if not d.startswith('.') and d != 'node_modules']
            
            for filename in files:
                if filename in ('_context', '_context.json'):
                    filepath = os.path.join(root, filename)
                    try:
                        with open(filepath) as f:
                            data = json.load(f)
                        extract_urls(data, urls)
                    except:
                        pass
        
        print('\n'.join(sorted(urls)))
        PYEOF
        )
        
        if [ -z "$UNIQUE_URLS" ]; then
          echo "No external context URLs found." >> $GITHUB_STEP_SUMMARY
          echo "status=success" >> $GITHUB_OUTPUT
          echo "failed_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check each URL
        PASSED_URLS=""
        FAILED_URLS=""
        FAILED=0
        PASSED=0
        
        while IFS= read -r url; do
          if [ -n "$url" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
              PASSED_URLS="${PASSED_URLS}| ${url} | ${HTTP_CODE} |
        "
              PASSED=$((PASSED + 1))
            else
              FAILED_URLS="${FAILED_URLS}| ${url} | ${HTTP_CODE} |
        "
              FAILED=$((FAILED + 1))
            fi
          fi
        done <<< "$UNIQUE_URLS"
        
        # Output results
        if [ $PASSED -gt 0 ]; then
          echo "### Accessible ($PASSED)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| URL | HTTP Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "$PASSED_URLS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ $FAILED -gt 0 ]; then
          echo "### Inaccessible ($FAILED)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| URL | HTTP Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "$FAILED_URLS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**$FAILED context URL(s) failed validation.** Files in this repository that depend on these contexts will not resolve correctly." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Possible causes:**" >> $GITHUB_STEP_SUMMARY
          echo "- The upstream context server is temporarily unavailable" >> $GITHUB_STEP_SUMMARY
          echo "- The URL is incorrect in the _context file" >> $GITHUB_STEP_SUMMARY
          echo "- The external context has been moved or removed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To resolve:** Review the URLs listed above and verify they are correct and accessible." >> $GITHUB_STEP_SUMMARY
          
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          echo "$FAILED_URLS" > /tmp/failed_urls.txt
        else
          echo "All context URLs are accessible." >> $GITHUB_STEP_SUMMARY
          echo "status=success" >> $GITHUB_OUTPUT
          echo "failed_count=0" >> $GITHUB_OUTPUT
        fi
        
        exit 0

    - name: Create issue for failed contexts
      if: inputs.create-issue == 'true' && steps.check.outputs.status == 'failure'
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        FAILED_COUNT: ${{ steps.check.outputs.failed_count }}
      run: |
        set +e
        FAILED_URLS=$(cat /tmp/failed_urls.txt 2>/dev/null || echo "Unknown")
        
        EXISTING=$(gh issue list --label "context-validation" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
        
        BODY="## Context URL Validation Failed

        **$FAILED_COUNT context URL(s) are not accessible:**

        $FAILED_URLS

        ### Impact
        Files in this repository that depend on these contexts will not resolve correctly until these URLs become available.

        ### Action Required
        - Check if the upstream context servers are available
        - Verify the URLs are correct in the _context files
        - Contact the maintainers of the external contexts if needed

        ---
        *This issue was automatically created by the context validation workflow.*"

        if [ -n "$EXISTING" ]; then
          gh issue comment "$EXISTING" --body "$BODY" || true
          echo "Updated existing issue #$EXISTING"
        else
          gh issue create \
            --title "Context URL Validation Failed" \
            --body "$BODY" \
            --label "context-validation,automated" || true
          echo "Created new issue"
        fi
        
        exit 0
