name: JSONLD Graph Builder Workflow

on:
  workflow_dispatch:
  workflow_call:

jobs:
  find-directories:
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.find-dirs.outputs.directories }}
    steps:
      - name: Download synced files
        uses: actions/download-artifact@v4
        with:
          name: synced-files

      - name: Find subdirectories (excluding . and hidden dirs)
        id: find-dirs
        run: |
          directories=$(find . -mindepth 1 -maxdepth 1 -type d -not -path '*/.*' \
            | sed 's|^\./||' \
            | sort \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "directories=$directories" >> $GITHUB_OUTPUT
          echo "ðŸ“‚ Subdirectories to process: $directories" >> $GITHUB_STEP_SUMMARY

  process-directories:
    needs: find-directories
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ${{ fromJson(needs.find-directories.outputs.directories) }}
      fail-fast: false
    steps:

      - name: Download synced files artifact
        uses: actions/download-artifact@v4
        with:
          name: synced-files
          path: .

      - name: Process JSON-LD files in ${{ matrix.directory }}
        run: |
          cd "${{ matrix.directory }}"

          REPO="${GITHUB_REPOSITORY}"
          BASE_URL="https://${REPO%%/*}.github.io/${REPO##*/}"
          CONTEXT_URL="$BASE_URL/${{ matrix.directory }}/@context"

          if ls *.json 1> /dev/null 2>&1 && ls *@context* 1> /dev/null 2>&1; then

            rm -f graph.jsonld graph.min.jsonld

            echo '{"@context":"'"$CONTEXT_URL"'","data":[]}' > graph.jsonld
            for file in *.json; do
              [ "$file" = "graph.jsonld" ] && continue
              content=$(jq --arg url "$CONTEXT_URL" '.["@context"] = $url' "$file" | \
                        jq --arg f "$file" '{_source: $f, _content: .}')
              jq --argjson new "$content" '.data += [$new]' graph.json > tmp.json && mv tmp.json graph.jsonld
            done
            echo "âœ… Generated graph.jsonld in ${{ matrix.directory }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Skipping ${{ matrix.directory }} â€” missing *.json or @context file" >> $GITHUB_STEP_SUMMARY
          fi
        # env:
        #   GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload modified files
        uses: actions/upload-artifact@v4
        with:
          name: matrix-files-${{ matrix.directory }}
          path: ${{ matrix.directory }}
      

  combine-artifacts:
    needs: process-directories
    runs-on: ubuntu-latest
    steps:
      - name: Download all synced-files artifacts
        run: |
          # For each directory, download its artifact
          for dir in $DIRS; do

            echo "Downloading artifact for $dir"
            gh run download-artifact --name matrix-files-$dir --dir $dir || echo "No artifact for $dir"
          done
        env:
          DIRS: ${{ join(fromJson(needs.find-directories.outputs.directories == '' ? '[]' : needs.find-directories.outputs.directories), ' ') }}
          # DIRS: ${{ join(fromJson(needs.find-directories.outputs.directories), ' ') }}

      # Optional: merge graph.json files from all directories into one big graph.json here

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: synced-files
          path: .