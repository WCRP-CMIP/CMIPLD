name: JSONLD Graph Builder Workflow

on:
  workflow_dispatch:
        inputs:
      updated:
        description: 'Only process updated directories?'
        required: true
        default: 'false'
        options:
          - 'true'
          - 'false'
        type: boolean
  workflow_call:
    inputs:
      updated:
        description: 'Only process updated directories?'
        required: true
        default: false
        type: boolean


permissions:
  actions: write
  contents: read

jobs:

  find-updated-directories:
    runs-on: ubuntu-latest
    if: ${{ inputs.updated == true }}
    outputs:
      directories: ${{ steps.changed-files.outputs.all_changed_files }}
    steps:
      - uses: actions/checkout@v4
      - uses: tj-actions/changed-files@v40
        id: changed-files
        with:
          dir_names: true
          json: true
          dir_names_exclude_current_dir: true
      - run: |
        echo "ðŸ“‚ Updated directories: ${{ steps.changed-files.outputs.all_changed_files }}" >> $GITHUB_STEP_SUMMARY

  find-all-directories:
    runs-on: ubuntu-latest
    if : ${{ inputs.updated == false }}
    outputs:
      directories: ${{ steps.find-dirs.outputs.directories }}
    steps:
      # TO ADD IF CHANGED, ELSE try all
      - name: Find all subdirectories (excluding . and hidden dirs)
        id: find-dirs
        run: |
          directories=$(find . -mindepth 1 -maxdepth 1 -type d -not -path '*/.*' \
            | sed 's|^\./||' \
            | sort \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "directories=$directories" >> $GITHUB_OUTPUT
          echo "ðŸ“‚ Subdirectories to process: $directories" >> $GITHUB_STEP_SUMMARY


  process-directories:
    needs: find-directories
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: ${{ fromJson(needs.find-directories.outputs.directories) }}
      fail-fast: false
    steps:


      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: production

      - name: Set GitHub Pages URL
        id: set-url
        run: |
          PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "PAGES_URL=$PAGES_URL" >> $GITHUB_ENV
        shell: bash

      - name: Process JSON-LD files in ${{ matrix.directory }}
        run: |
          cd "${{ matrix.directory }}"


          # bash <(curl -s https://wcrp-cmip.github.io/CMIPLD/bin/ld2graph)../${{ matrix.directory }}
          curl -s https://wcrp-cmip.github.io/CMIPLD/bin/ld2graph | bash -s ../${{ matrix.directory }}


      - name: Install jsonld CLI
        run: |
          npm install -g git+https://github.com/digitalbazaar/jsonld-cli.git
        shell: bash

      - name: Validate JSON-LD from URL
        run: |
          jsonld lint "$PAGES_URL/graph.jsonld" || exit 1
        shell: bash

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update JSON-LD graph in ${{ matrix.directory }}"
          branch: production
          file_pattern: "${{ matrix.directory }}/graph*"
          author_name: "cmip-ipo"
          author_email: "actions@wcrp-cmip.org"
          commit_user_name: "cmip-ipo"
          commit_user_email: "actions@wcrp-cmip.org"
          push_options: "--force"

