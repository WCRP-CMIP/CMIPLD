name: JSONLD Graph Builder

# üîí Prevent race-condition push failures
# Ensures only ONE run of this workflow may push to `production` at a time  
concurrency:
  group: jsonld-graph-builder-production
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      updated:
        description: "Only process updated directories?"
        required: true
        default: false
        type: boolean
  workflow_call:
    inputs:
      updated:
        description: "Only process updated directories?"
        required: true
        default: false
        type: boolean

permissions:
  actions: write
  contents: write

jobs:
  find-updated-directories:
    if: ${{ inputs.updated == true }}
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.find.outputs.directories }}
    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/find-updated-directories@main
        id: find
        with:
          base-branch: production

  find-all-directories:
    if: ${{ inputs.updated == false }}
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.find.outputs.directories }}
    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/find-all-directories@main
        id: find

  set-directories:
    runs-on: ubuntu-latest
    needs:
      - find-updated-directories
      - find-all-directories
    if: ${{ always() && ((needs.find-updated-directories.result == 'success') || (needs.find-all-directories.result == 'success')) }}
    outputs:
      directories: ${{ steps.set.outputs.directories }}
    steps:
      - id: set
        run: |
          if [ "${{ inputs.updated }}" = "true" ]; then
            dirs='${{ needs.find-updated-directories.outputs.directories }}'
            echo "Using updated directories: $dirs"
          else
            dirs='${{ needs.find-all-directories.outputs.directories }}'
            echo "Using all directories: $dirs"
          fi
          
          SKIP_DIRS='["project", "ignore", ".github"]'
          dirs=$(echo "$dirs" | jq -c --argjson skip "$SKIP_DIRS" '. - $skip')
          
          if [ "$dirs" = "" ] || [ "$dirs" = "null" ] || [ "$dirs" = "[]" ] || [ "$dirs" = '[""]' ]; then
            echo "No valid directories found, using fallback"
            dirs='[]'
          fi
          
          echo "directories=$dirs" >> "$GITHUB_OUTPUT"
          echo "Final directories for matrix: $dirs"

  process-directories:
    needs: set-directories
    if: ${{ always() && needs.set-directories.result == 'success' }}
    runs-on: ubuntu-latest

    concurrency:
      group: jsonld-graph-builder-production-push
      cancel-in-progress: false
    strategy:
      matrix:
        directory: ${{ fromJson(needs.set-directories.outputs.directories || '[]') }}
      fail-fast: false
      max-parallel: 10
    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/cmipld@main
        id: install-cmipld

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: production
          
      - name: Set GitHub Pages URL
        run: |
          echo "PAGES_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> "$GITHUB_ENV"
          
      - name: Process JSON-LD files in ${{ matrix.directory }}
        run: |
          echo "üîÑ Processing directory: ${{ matrix.directory }}"
          if [ -d "${{ matrix.directory }}" ]; then
            cd "${{ matrix.directory }}"
            ld2graph "../${{ matrix.directory }}" || exit 1
          else
            echo "‚ö†Ô∏è Skipping - directory doesn't exist"
            exit 1
          fi
          git add -f *graph* || true
          
      - name: Validate JSON-LD from URL
        run: |
          if [ -f "${{ matrix.directory }}/graph.jsonld" ]; then
            pyld test "${{ matrix.directory }}/graph.jsonld" > /dev/null 2>&1 || exit 1
          else
            echo "‚ö†Ô∏è No graph.jsonld found"
            exit 1
          fi

      - name: Minify graph.jsonld files
        run: |
          find . -type f -name "graph.jsonld" -print0 | while IFS= read -r -d '' file; do
            dir=$(dirname "$file")
            tr -d '[:space:]' < "$file" > "$dir/graph.min.json"
            cp "$dir/graph.min.json" "$dir/graph"
            cp "$dir/graph.min.json" "$dir/graph.json"
          done

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update JSON-LD graph in ${{ matrix.directory }}"
          branch: production
          file_pattern: "${{ matrix.directory }}/*graph*"
          commit_user_name: "cmip-ipo automation"
          commit_user_email: "actions@wcrp-cmip.org"
          # Safer than raw --force
          push_options: "--force-with-lease"
        continue-on-error: true

  production-served-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: production
      
      - name: Execute prepublish scripts
        env:
          PREPUBLISH_DIR: .github/prepublish
        run: |
          {
            echo "# Prepublish Scripts Report"
            
            if [ -d "$PREPUBLISH_DIR" ]; then
              for file in $PREPUBLISH_DIR/*.{sh,py}; do
                [ -f "$file" ] || continue
          
                echo '```'
                echo -e "#### $(basename "$file")\n"
                if [[ "$file" == *.py ]]; then
                  chmod +x "$file"
                  python "$file" 2>&1
                elif [[ "$file" == *.sh ]]; then
                  chmod +x "$file"
                  bash "$file" 2>&1
                fi
                
                echo -e '```\n'
              done
            else
              echo "‚ö†Ô∏è No prepublish directory found at $PREPUBLISH_DIR"
            fi
            
            echo "---"
            echo "Completed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          } >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push Pages Updates
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Pages files updated"
          branch: production
          file_pattern: "*/*"
          commit_user_name: "cmip-ipo automation"
          commit_user_email: "actions@wcrp-cmip.org"
          pull_options: '--rebase --autostash'
          push_options: '--force-with-lease'
        continue-on-error: false
