name: JSONLD Graph Builder

# Prevent race-condition push failures
# Ensures only ONE run of this workflow may push to `production` at a time  
concurrency:
  group: jsonld-graph-builder-production
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      updated:
        description: "Only process updated directories?"
        required: true
        default: false
        type: boolean
  workflow_call:
    inputs:
      updated:
        description: "Only process updated directories?"
        required: true
        default: false
        type: boolean

permissions:
  actions: write
  contents: write

jobs:
  find-updated-directories:
    if: ${{ inputs.updated == true }}
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.find.outputs.directories }}
    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/find-updated-directories@main
        id: find
        with:
          base-branch: production

  find-all-directories:
    if: ${{ inputs.updated == false }}
    runs-on: ubuntu-latest
    outputs:
      directories: ${{ steps.find.outputs.directories }}
    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/find-all-directories@main
        id: find

  set-directories:
    runs-on: ubuntu-latest
    needs:
      - find-updated-directories
      - find-all-directories
    if: ${{ always() && ((needs.find-updated-directories.result == 'success') || (needs.find-all-directories.result == 'success')) }}
    outputs:
      directories: ${{ steps.set.outputs.directories }}
    steps:
      - id: set
        run: |
          if [ "${{ inputs.updated }}" = "true" ]; then
            dirs='${{ needs.find-updated-directories.outputs.directories }}'
            echo "Using updated directories: $dirs"
          else
            dirs='${{ needs.find-all-directories.outputs.directories }}'
            echo "Using all directories: $dirs"
          fi
          
          SKIP_DIRS='["project", "ignore", ".github"]'
          dirs=$(echo "$dirs" | jq -c --argjson skip "$SKIP_DIRS" '. - $skip')
          
          if [ "$dirs" = "" ] || [ "$dirs" = "null" ] || [ "$dirs" = "[]" ] || [ "$dirs" = '[""]' ]; then
            echo "No valid directories found, using fallback"
            dirs='[]'
          fi
          
          echo "directories=$dirs" >> "$GITHUB_OUTPUT"
          echo "Final directories for matrix: $dirs"

  process-directories:
    needs: set-directories
    if: ${{ always() && needs.set-directories.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: WCRP-CMIP/CMIPLD/actions/cmipld@main
        id: install-cmipld

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: production
          
      - name: Set GitHub Pages URL
        run: |
          echo "PAGES_URL=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> "$GITHUB_ENV"
      
      - name: Initialize Report
        run: |
          {
            echo "# JSON-LD Graph Processing Report"
            echo ""
            echo "| Directory | Status | Processing | Validation | Minification | Commit |"
            echo "|-----------|--------|------------|------------|--------------|--------|"
          } >> $GITHUB_STEP_SUMMARY
          
      - name: Process All Directories
        run: |
          DIRECTORIES='${{ needs.set-directories.outputs.directories }}'
          
          if [ "$DIRECTORIES" = "[]" ] || [ "$DIRECTORIES" = "" ]; then
            echo "| *No directories to process* | ‚ÑπÔ∏è | - | - | - | - |" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Convert JSON array to bash array
          mapfile -t DIR_ARRAY < <(echo "$DIRECTORIES" | jq -r '.[]')
          
          echo "Total directories to process: ${#DIR_ARRAY[@]}"
          
          # Loop through each directory
          for dir in "${DIR_ARRAY[@]}"; do
            echo ""
            echo "========================================"
            echo "üîÑ Processing directory: $dir"
            echo "========================================"
            
            PROCESS_STATUS="‚úÖ"
            VALIDATE_STATUS="‚úÖ"
            MINIFY_STATUS="‚úÖ"
            COMMIT_STATUS="‚úÖ"
            OVERALL_STATUS="‚úÖ"
            
            # Process JSON-LD files
            if [ -d "$dir" ]; then
              echo "üìÅ Directory exists, processing..."
              (
                cd "$dir" || exit 1
                if ld2graph "../$dir" 2>&1; then
                  echo "‚úÖ Processing completed"
                else
                  echo "‚ùå Processing failed"
                  exit 1
                fi
              )
              if [ $? -eq 0 ]; then
                PROCESS_STATUS="‚úÖ"
              else
                PROCESS_STATUS="‚ùå"
                OVERALL_STATUS="‚ùå"
              fi
              git add -f "$dir"/*graph* 2>/dev/null || true
            else
              echo "‚ö†Ô∏è Directory doesn't exist: $dir"
              PROCESS_STATUS="‚ö†Ô∏è"
              OVERALL_STATUS="‚ö†Ô∏è"
              echo "| \`$dir\` | $OVERALL_STATUS | $PROCESS_STATUS | - | - | - |" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            
            # Validate JSON-LD
            echo "üîç Validating JSON-LD..."
            if [ -f "$dir/graph.jsonld" ]; then
              if pyld test "$dir/graph.jsonld" > /dev/null 2>&1; then
                VALIDATE_STATUS="‚úÖ"
                echo "‚úÖ Validation passed"
              else
                VALIDATE_STATUS="‚ùå"
                OVERALL_STATUS="‚ùå"
                echo "‚ùå Validation failed"
              fi
            else
              echo "‚ö†Ô∏è No graph.jsonld found in $dir"
              VALIDATE_STATUS="‚ö†Ô∏è"
              OVERALL_STATUS="‚ö†Ô∏è"
            fi
            
            # Minify graph.jsonld
            echo "üì¶ Minifying..."
            if [ -f "$dir/graph.jsonld" ]; then
              if tr -d '[:space:]' < "$dir/graph.jsonld" > "$dir/graph.min.json" && \
                 cp "$dir/graph.min.json" "$dir/graph" && \
                 cp "$dir/graph.min.json" "$dir/graph.json"; then
                MINIFY_STATUS="‚úÖ"
                echo "‚úÖ Minification completed"
              else
                MINIFY_STATUS="‚ùå"
                OVERALL_STATUS="‚ùå"
                echo "‚ùå Minification failed"
              fi
            else
              MINIFY_STATUS="‚ö†Ô∏è"
            fi
            
            # Report to summary
            echo "| \`$dir\` | $OVERALL_STATUS | $PROCESS_STATUS | $VALIDATE_STATUS | $MINIFY_STATUS | $COMMIT_STATUS |" >> $GITHUB_STEP_SUMMARY
            echo "Status reported for: $dir"
          done
          
          echo ""
          echo "========================================"
          echo "‚úÖ All directories processed"
          echo "========================================"
          
          # Add summary to report
          {
            echo ""
            echo "---"
            echo "**Completed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "**Total directories processed:** ${#DIR_ARRAY[@]}"
          } >> $GITHUB_STEP_SUMMARY

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Update JSON-LD graphs"
          branch: production
          file_pattern: "*/*graph*"
          commit_user_name: "cmip-ipo automation"
          commit_user_email: "actions@wcrp-cmip.org"
          pull_options: '--rebase --autostash'
          push_options: ''
        continue-on-error: true

  production-served-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: production
      
      - name: Execute prepublish scripts
        env:
          PREPUBLISH_DIR: .github/prepublish
        run: |
          {
            echo "# Prepublish Scripts Report"
            
            if [ -d "$PREPUBLISH_DIR" ]; then
              for file in $PREPUBLISH_DIR/*.{sh,py}; do
                [ -f "$file" ] || continue
          
                echo '```'
                echo -e "#### $(basename "$file")\n"
                if [[ "$file" == *.py ]]; then
                  chmod +x "$file"
                  python "$file" 2>&1
                elif [[ "$file" == *.sh ]]; then
                  chmod +x "$file"
                  bash "$file" 2>&1
                fi
                
                echo -e '```\n'
              done
            else
              echo "‚ö†Ô∏è No prepublish directory found at $PREPUBLISH_DIR"
            fi
            
            echo "---"
            echo "Completed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          } >> $GITHUB_STEP_SUMMARY

      - name: Commit and Push Pages Updates
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Pages files updated"
          branch: production
          file_pattern: "*/*"
          commit_user_name: "cmip-ipo automation"
          commit_user_email: "actions@wcrp-cmip.org"
          pull_options: '--rebase --autostash'
        continue-on-error: false